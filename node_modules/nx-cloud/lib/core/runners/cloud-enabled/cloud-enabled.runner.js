const a1_0x40ce=['uploadedToStorage','nx-cloud/lib/daemon/process-run-end','exit','resolve','rxjs/internal/Subject','../../terminal-output/message-reporter','printMessages','https://nx.app','value','writeFileSync','../../../utilities/environment','ACCESS_TOKEN','catch','note','__awaiter','FileStorage','cacheStatus','filter','url','subscribe','MessageReporter','throw','../../../utilities/metric-logger','submitRunMetrics','forEach','apply','join','./cloud-enabled-life-cycle','lifeCycle','runUrl','removeTrailingSlash','../../../utilities/nx-imports-light','local-cache-hit','\x20isn\x27t\x20recorded','encryptionKey','Nx\x20Cloud\x20wasn\x27t\x20able\x20to\x20store\x20artifacts.','VERBOSE_LOGGING','CloudEnabledLifeCycle','error','waitForStoreRequestsToComplete','map','Nx\x20Cloud\x20wasn\x27t\x20able\x20to\x20record\x20its\x20run.','getCIExecutionId','anyErrors','ErrorReporterApi','getBranch','./cloud-remote-cache','Executed\x20tasks\x20with\x20hashes:\x20','endRun','ENCRYPTION_KEY','cacheableOperations','../../terminal-output/end-of-run-message','delayedStoreRequests','__esModule','EndOfRunMessage','../../terminal-output/output-obfuscator','accessToken','defineProperty','all','getRunGroup','fs-extra','toString','NX_CLOUD_DISTRIBUTED_EXECUTION_ID','length','skipNxCache','warn','parseCommand','getCIExecutionEnv','path','maskedProperties','CloudRemoteCache','pathExists','../../api/error-reporter.api','toISOString','hash','find','enabled','store','cloud-enabled-runner','./id-generator','cloudEnabledTasksRunner','tasks-hashes-','E2EEncryption','daemon','next','env','storedHashes','extractGitSha','printCacheHitsMessage','../../../utilities/remove-trailing-slash','complete','processInBackground','assign','agentRunningInDistributedExecution','requests','DISTRIBUTED_TASK_EXECUTION_INTERNAL_ERROR_STATUS_CODE','getMachineInfo'];(function(_0x3b9822,_0x40ce92){const _0x3221e1=function(_0x2d8151){while(--_0x2d8151){_0x3b9822['push'](_0x3b9822['shift']());}};_0x3221e1(++_0x40ce92);}(a1_0x40ce,0x73));const a1_0x3221=function(_0x3b9822,_0x40ce92){_0x3b9822=_0x3b9822-0x0;let _0x3221e1=a1_0x40ce[_0x3b9822];return _0x3221e1;};'use strict';var __awaiter=this&&this[a1_0x3221('0x5d')]||function(_0x5c87ed,_0x35c33f,_0x4ef2f1,_0x3a250c){function _0x4e37bd(_0x34f308){return _0x34f308 instanceof _0x4ef2f1?_0x34f308:new _0x4ef2f1(function(_0x1fbe75){_0x1fbe75(_0x34f308);});}return new(_0x4ef2f1||(_0x4ef2f1=Promise))(function(_0x27b509,_0x2faf7c){function _0x448672(_0x187a83){try{_0x2fd4de(_0x3a250c['next'](_0x187a83));}catch(_0x2d1f0f){_0x2faf7c(_0x2d1f0f);}}function _0x39f5ba(_0x279d6b){try{_0x2fd4de(_0x3a250c[a1_0x3221('0x3')](_0x279d6b));}catch(_0x2c2162){_0x2faf7c(_0x2c2162);}}function _0x2fd4de(_0x3ea5c1){_0x3ea5c1['done']?_0x27b509(_0x3ea5c1[a1_0x3221('0x57')]):_0x4e37bd(_0x3ea5c1[a1_0x3221('0x57')])['then'](_0x448672,_0x39f5ba);}_0x2fd4de((_0x3a250c=_0x3a250c[a1_0x3221('0x7')](_0x5c87ed,_0x35c33f||[]))[a1_0x3221('0x42')]());});};Object[a1_0x3221('0x27')](exports,a1_0x3221('0x23'),{'value':!![]});exports[a1_0x3221('0x3e')]=void 0x0;const message_reporter_1=require(a1_0x3221('0x54'));const end_of_run_message_1=require(a1_0x3221('0x21'));const output_obfuscator_1=require(a1_0x3221('0x25'));const cloud_enabled_life_cycle_1=require(a1_0x3221('0x9'));const file_storage_1=require('../../file-storage/file-storage');const e2e_encryption_1=require('../../file-storage/e2e-encryption');const environment_1=require(a1_0x3221('0x59'));const cloud_remote_cache_1=require(a1_0x3221('0x1c'));const cloud_run_api_1=require('./cloud-run.api');const fs_1=require('fs');const path=require('path');const path_1=require(a1_0x3221('0x32'));const metric_logger_1=require(a1_0x3221('0x4'));const error_reporter_api_1=require(a1_0x3221('0x36'));const fs_extra_1=require(a1_0x3221('0x2a'));const id_generator_1=require(a1_0x3221('0x3d'));const remove_trailing_slash_1=require(a1_0x3221('0x47'));const {output}=require(a1_0x3221('0xd'));const {tasksRunner,cacheDirectory}=require('../../../utilities/nx-imports');function createApi(_0x1d8d12,_0x4e023d,_0xbdfc84){const _0x53be0c=(0x0,environment_1[a1_0x3221('0x4e')])();return new cloud_run_api_1['CloudRunApi'](_0x1d8d12,_0xbdfc84,_0x4e023d,_0x53be0c);}function storeTaskHashes(_0x4446f9,_0x349ba1,_0x105679){const _0x1a0a07=JSON['stringify'](_0x4446f9[a1_0x3221('0x16')](_0x239eb6=>({'taskId':_0x239eb6['taskId'],'hash':_0x239eb6[a1_0x3221('0x38')]})));if(environment_1[a1_0x3221('0x12')]){output[a1_0x3221('0x5c')]({'title':a1_0x3221('0x1d')+_0x1a0a07});}(0x0,fs_1[a1_0x3221('0x58')])(path[a1_0x3221('0x8')](_0x349ba1,a1_0x3221('0x3f')+_0x105679),_0x1a0a07);}function storeLocalCacheHits(_0x487b0a,_0x1ff21f,_0x279ef9){const _0x7723e5=_0x487b0a[a1_0x3221('0x60')](_0x30cd7e=>_0x30cd7e[a1_0x3221('0x5f')]===a1_0x3221('0xe'))[a1_0x3221('0x16')](_0x1d5419=>_0x1d5419[a1_0x3221('0x38')]);_0x7723e5[a1_0x3221('0x6')](_0x16eba0=>_0x1ff21f[a1_0x3221('0x3b')](_0x16eba0,_0x279ef9));}function onComplete({daemon,options,fileStorage,remoteCache,api,outputObfuscator,runStartTime,messages,endOfRunMessage,taskExecutions,versionOfNxBefore133,inner,encryptionKey,storeInCurrentProcess,distributedExecutionId,runContext}){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x5d0196=new Date()[a1_0x3221('0x37')]();const _0x53c320=(0x0,environment_1[a1_0x3221('0x1b')])();const _0x5d3567={'command':outputObfuscator['obfuscate']((0x0,environment_1[a1_0x3221('0x30')])()),'startTime':runStartTime,'endTime':_0x5d0196,'distributedExecutionId':distributedExecutionId,'branch':_0x53c320,'runGroup':(0x0,environment_1[a1_0x3221('0x29')])(),'sha':_0x53c320?(0x0,environment_1[a1_0x3221('0x45')])():undefined,'inner':inner};const _0x1de899={'branch':_0x53c320,'runGroup':(0x0,environment_1[a1_0x3221('0x29')])(),'ciExecutionId':(0x0,environment_1[a1_0x3221('0x18')])(),'ciExecutionEnv':(0x0,environment_1[a1_0x3221('0x31')])()};if(storeInCurrentProcess){if((0x0,environment_1['agentRunningInDistributedExecution'])(distributedExecutionId)){storeTaskHashes(taskExecutions,cacheDirectory,distributedExecutionId);storeLocalCacheHits(taskExecutions,remoteCache,cacheDirectory);}try{yield remoteCache[a1_0x3221('0x15')]();}catch(_0x41ea07){output[a1_0x3221('0x14')]({'title':a1_0x3221('0x11')});messages['printMessages']();return![];}for(const _0x295f6c of fileStorage[a1_0x3221('0x44')]){const _0x183001=taskExecutions[a1_0x3221('0x39')](_0xa5fb94=>_0xa5fb94['hash']===_0x295f6c);if(!_0x183001){throw new Error('Task\x20with\x20hash\x20'+_0x295f6c+a1_0x3221('0xf'));}_0x183001[a1_0x3221('0x4f')]=!![];}try{yield api[a1_0x3221('0x1e')](_0x5d3567,taskExecutions,_0x1de899);}catch(_0x4ab51c){output[a1_0x3221('0x14')]({'title':a1_0x3221('0x17')});messages[a1_0x3221('0x55')]();return![];}yield(0x0,metric_logger_1[a1_0x3221('0x5')])(options);}else{try{const _0x43ab29=environment_1[a1_0x3221('0x5a')]?environment_1[a1_0x3221('0x5a')]:options[a1_0x3221('0x26')];const _0x27b56f=(0x0,id_generator_1['generateUniqueLinkId'])();const _0x160e02=require[a1_0x3221('0x52')](a1_0x3221('0x50'));yield daemon[a1_0x3221('0x49')](_0x160e02,{'encryptionKey':encryptionKey,'runnerOptions':Object[a1_0x3221('0x4a')](Object[a1_0x3221('0x4a')]({},options),{'accessToken':_0x43ab29}),'delayedStoreRequests':remoteCache[a1_0x3221('0x22')],'ciExecutionContext':_0x1de899,'runEnd':{'runData':_0x5d3567,'taskExecutions':taskExecutions,'linkId':_0x27b56f}});runContext[a1_0x3221('0xb')]=(0x0,remove_trailing_slash_1[a1_0x3221('0xc')])(options[a1_0x3221('0x0')]||a1_0x3221('0x56'))+'/runs/'+_0x27b56f;}catch(_0x11ad66){output[a1_0x3221('0x2f')]({'title':'Nx\x20Cloud\x20Problems','bodyLines':[_0x11ad66['message']||_0x11ad66[a1_0x3221('0x2b')]()]});return![];}}if(versionOfNxBefore133){setTimeout(()=>{messages[a1_0x3221('0x55')]();if(!messages[a1_0x3221('0x19')]&&!inner){endOfRunMessage[a1_0x3221('0x46')]();}},0x0);}else{messages['printMessages']();if(!messages[a1_0x3221('0x19')]&&!inner){endOfRunMessage[a1_0x3221('0x46')]();}}return!![];});}function createLifeCycle(_0x360aa7,_0x29485f,_0x337ccd,_0x27eb2d){const _0x402b1d=new cloud_enabled_life_cycle_1[(a1_0x3221('0x13'))](_0x360aa7,cacheDirectory,!![],_0x29485f[a1_0x3221('0x20')]||[],_0x337ccd,_0x27eb2d);try{const {CompositeLifeCycle}=require('../../../utilities/nx-imports');if(!CompositeLifeCycle)return _0x402b1d;return new CompositeLifeCycle([_0x29485f[a1_0x3221('0xa')],_0x402b1d]);}catch(_0x19998e){return _0x402b1d;}}function fetchUrlsForKnownHashesUpfront(_0x1a22b9,_0x53d6bb,_0x4cd8a2,_0x518617,_0x21e613){return __awaiter(this,void 0x0,void 0x0,function*(){if(_0x518617[a1_0x3221('0x2e')])return;let _0x3f0341=_0x4cd8a2[a1_0x3221('0x16')](_0xca6eb8=>_0xca6eb8[a1_0x3221('0x38')])[a1_0x3221('0x60')](_0x1c0560=>!!_0x1c0560);const _0x592427=yield Promise[a1_0x3221('0x28')](_0x3f0341[a1_0x3221('0x16')](_0x12b411=>{const _0x4cc6c1=(0x0,path_1[a1_0x3221('0x8')])(cacheDirectory,_0x12b411+'.commit');return(0x0,fs_extra_1[a1_0x3221('0x35')])(_0x4cc6c1);}));const _0x5c995d=[];for(let _0x3af057=0x0;_0x3af057<_0x592427[a1_0x3221('0x2d')];++_0x3af057){if(!_0x592427[_0x3af057]){_0x5c995d['push'](_0x3f0341[_0x3af057]);}}if(_0x5c995d[a1_0x3221('0x2d')]>0x0){const _0x2397f=_0x1a22b9['startRun'](_0x21e613,_0x5c995d);for(const _0x3eb3be of _0x5c995d){_0x53d6bb[a1_0x3221('0x4c')][_0x3eb3be]=_0x2397f;}}});}function cloudEnabledTasksRunner(_0xb9ccd3,_0x14f338,_0x3fdbb6,_0x155b1d=![]){var _0x7db61f;const _0x2589b0=process[a1_0x3221('0x43')]['NX_CLOUD_DISTRIBUTED_EXECUTION_ID'];const _0x2f67f2={'statuses':{},'scheduledTasks':[],'requests':{},'allTasks':_0xb9ccd3};const _0x3b5a9d=_0x14f338[a1_0x3221('0xa')]===undefined;const _0x2feb7e=[];const _0x49e5f6=new message_reporter_1[(a1_0x3221('0x2'))](_0x14f338);const _0x240e73=createApi(_0x49e5f6,_0x14f338,_0x2f67f2);const _0x293502=new end_of_run_message_1[(a1_0x3221('0x24'))](_0x2f67f2,_0x2feb7e,_0x2589b0);const _0x1d9384=new output_obfuscator_1['OutputObfuscator'](_0x14f338[a1_0x3221('0x33')]);const _0x324298=new Date()[a1_0x3221('0x37')]();const _0x5c5dac=createLifeCycle(_0x2f67f2,_0x14f338,_0x1d9384,_0x2feb7e);const _0x3285af=environment_1[a1_0x3221('0x1f')]||_0x14f338[a1_0x3221('0x10')];const _0x75e757=new e2e_encryption_1[(a1_0x3221('0x40'))](_0x3285af);const _0x5719b9=new error_reporter_api_1[(a1_0x3221('0x1a'))](_0x14f338);const _0x1a9d06=(0x0,environment_1['agentRunningInDistributedExecution'])(_0x2589b0)||!((_0x7db61f=_0x3fdbb6[a1_0x3221('0x41')])===null||_0x7db61f===void 0x0?void 0x0:_0x7db61f[a1_0x3221('0x3a')]());const _0x41ed98=new file_storage_1[(a1_0x3221('0x5e'))](_0x75e757,_0x5719b9,_0x14f338,a1_0x3221('0x3c'));const _0xe4b029=new cloud_remote_cache_1[(a1_0x3221('0x34'))](_0x49e5f6,_0x240e73,_0x2f67f2,_0x41ed98,_0x2589b0,_0x1a9d06);fetchUrlsForKnownHashesUpfront(_0x240e73,_0x2f67f2,_0xb9ccd3,_0x14f338,_0x2589b0);delete process['env'][a1_0x3221('0x2c')];const _0x5d7b9a=tasksRunner(_0xb9ccd3,Object[a1_0x3221('0x4a')](Object['assign']({},_0x14f338),{'remoteCache':_0xe4b029,'lifeCycle':_0x5c5dac}),_0x3fdbb6);if(_0x5d7b9a[a1_0x3221('0x1')]){const {Subject}=require(a1_0x3221('0x53'));const _0x140a74=new Subject();_0x5d7b9a[a1_0x3221('0x1')]({'next':_0x44cd5e=>_0x140a74[a1_0x3221('0x42')](_0x44cd5e),'error':_0x41fa40=>_0x140a74['error'](_0x41fa40),'complete':()=>__awaiter(this,void 0x0,void 0x0,function*(){const _0x118b5a=yield onComplete({'daemon':_0x3fdbb6['daemon'],'options':_0x14f338,'fileStorage':_0x41ed98,'remoteCache':_0xe4b029,'api':_0x240e73,'outputObfuscator':_0x1d9384,'runStartTime':_0x324298,'messages':_0x49e5f6,'endOfRunMessage':_0x293502,'taskExecutions':_0x2feb7e,'versionOfNxBefore133':_0x3b5a9d,'inner':_0x155b1d,'encryptionKey':_0x3285af,'storeInCurrentProcess':_0x1a9d06,'runContext':_0x2f67f2,'distributedExecutionId':_0x2589b0});if(!_0x118b5a&&(0x0,environment_1[a1_0x3221('0x4b')])(_0x2589b0)){process[a1_0x3221('0x51')](environment_1[a1_0x3221('0x4d')]);}_0x140a74[a1_0x3221('0x48')]();})});return _0x140a74;}else{return _0x5d7b9a['then'](_0xf5a427=>__awaiter(this,void 0x0,void 0x0,function*(){const _0x5b6724=yield onComplete({'daemon':_0x3fdbb6[a1_0x3221('0x41')],'options':_0x14f338,'fileStorage':_0x41ed98,'remoteCache':_0xe4b029,'api':_0x240e73,'outputObfuscator':_0x1d9384,'runStartTime':_0x324298,'messages':_0x49e5f6,'endOfRunMessage':_0x293502,'taskExecutions':_0x2feb7e,'versionOfNxBefore133':_0x3b5a9d,'inner':_0x155b1d,'encryptionKey':_0x3285af,'storeInCurrentProcess':_0x1a9d06,'runContext':_0x2f67f2,'distributedExecutionId':_0x2589b0});if(!_0x5b6724&&(0x0,environment_1[a1_0x3221('0x4b')])(_0x2589b0)){process[a1_0x3221('0x51')](environment_1[a1_0x3221('0x4d')]);}return _0xf5a427;}))[a1_0x3221('0x5b')](_0x4469c6=>__awaiter(this,void 0x0,void 0x0,function*(){const _0x4a223e=yield onComplete({'daemon':_0x3fdbb6['daemon'],'options':_0x14f338,'fileStorage':_0x41ed98,'remoteCache':_0xe4b029,'api':_0x240e73,'outputObfuscator':_0x1d9384,'runStartTime':_0x324298,'messages':_0x49e5f6,'endOfRunMessage':_0x293502,'taskExecutions':_0x2feb7e,'versionOfNxBefore133':_0x3b5a9d,'inner':_0x155b1d,'encryptionKey':_0x3285af,'storeInCurrentProcess':_0x1a9d06,'runContext':_0x2f67f2,'distributedExecutionId':_0x2589b0});if(!_0x4a223e&&(0x0,environment_1[a1_0x3221('0x4b')])(_0x2589b0)){process[a1_0x3221('0x51')](environment_1[a1_0x3221('0x4d')]);}throw _0x4469c6;}));}}exports[a1_0x3221('0x3e')]=cloudEnabledTasksRunner;