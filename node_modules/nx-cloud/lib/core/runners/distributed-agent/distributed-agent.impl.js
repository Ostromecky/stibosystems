const a6_0x24c1=['/nx.json','../../file-storage/e2e-encryption','options','value','Agent\x20was\x20terminated\x20via\x20SIGTERM','readdirSync','SIGTERM','invokeTasksUsingNxImperativeApi','done','parse','length','We\x20have\x20detected\x20another\x20agent\x20with\x20this\x20ID\x20running\x20in\x20this\x20workspace.\x20This\x20should\x20not\x20happen.','then','cacheableOperations','trim','join','getCIExecutionId','getBranch','writeFileSync','Agent\x20was\x20terminated\x20via\x20SIGINT','../../../utilities/is-workspace-enabled','We\x20have\x20detected\x20other\x20agents\x20running\x20in\x20this\x20workspace.\x20This\x20can\x20cause\x20unexpected\x20behavior.','warn','tasksRunnerOptions','../../error/print-cacheable-targets-error','completeRunGroupWithError','End\x20all\x20currently\x20running\x20agents,\x20run\x20\x22npx\x20nx-cloud\x20clean-up-agents\x22,\x20and\x20try\x20again.','ENCRYPTION_KEY','startAgent','exit','Critical\x20Error\x20in\x20Agent:\x20\x22','./invoke-tasks-using-nx-imperative-api','NX_AGENT_NAME','runner','Other\x20Nx\x20Cloud\x20Agents\x20Detected','CIRCLE_JOB','catch','invokeTasksUsingRunMany','DteArtifactStorage','./execute-tasks','submitRunMetrics','../../api/error-reporter.api','mkdirSync','map','env','../../../utilities/dte-artifact-storage','strip-json-comments','DistributedAgentApi','filter','executeTasks','getCIExecutionEnv','../../file-storage/file-storage','floor','targets','../../error/print-invalid-runner-error','E2EEncryption','some','next','FileStorage','canDetectRunGroup','printInvalidRunnerError','SIGINT','yargs-parser','encryptionKey','Distributed\x20Task\x20Execution\x20is\x20disabled\x20when\x20your\x20workspace\x20is\x20disabled','readFileSync','includes','dte-agent','message','Starting\x20an\x20agent\x20for\x20running\x20Nx\x20tasks','Organization\x20administrators\x20can\x20find\x20more\x20information\x20on\x20the\x20\x27Billing\x20and\x20Plans\x27\x20page\x20in\x20the\x20Nx\x20Cloud\x20Webapp','Duplicate\x20Agent\x20ID\x20Detected','existsSync','isWorkspaceEnabled','/lockfiles','Nx\x20Cloud:\x20Workspace\x20is\x20disabled','CIRCLECI','argv','CIRCLE_STAGE','Starting\x20an\x20agent\x20for\x20running\x20Nx\x20target(s)\x20[','../../../utilities/nx-imports-light','unlinkSync','note','@nrwl/nx-cloud','printRunGroupError','.lock','If\x20you\x20believe\x20this\x20is\x20the\x20case,\x20run\x20\x22npx\x20nx-cloud\x20clean-up-agents\x22.'];(function(_0x4d9eee,_0x24c11e){const _0x32ce65=function(_0x4de031){while(--_0x4de031){_0x4d9eee['push'](_0x4d9eee['shift']());}};_0x32ce65(++_0x24c11e);}(a6_0x24c1,0x1aa));const a6_0x32ce=function(_0x4d9eee,_0x24c11e){_0x4d9eee=_0x4d9eee-0x0;let _0x32ce65=a6_0x24c1[_0x4d9eee];return _0x32ce65;};'use strict';var __awaiter=this&&this['__awaiter']||function(_0x39032d,_0x5fd644,_0xa61360,_0x695753){function _0x325284(_0x493b7e){return _0x493b7e instanceof _0xa61360?_0x493b7e:new _0xa61360(function(_0x41ab35){_0x41ab35(_0x493b7e);});}return new(_0xa61360||(_0xa61360=Promise))(function(_0x353fd6,_0x414288){function _0x44b9e9(_0x87c3cf){try{_0x41517f(_0x695753[a6_0x32ce('0x42')](_0x87c3cf));}catch(_0x3c8842){_0x414288(_0x3c8842);}}function _0x39a243(_0x3f97a1){try{_0x41517f(_0x695753['throw'](_0x3f97a1));}catch(_0x4591de){_0x414288(_0x4591de);}}function _0x41517f(_0x5c270b){_0x5c270b[a6_0x32ce('0x11')]?_0x353fd6(_0x5c270b[a6_0x32ce('0xc')]):_0x325284(_0x5c270b['value'])[a6_0x32ce('0x15')](_0x44b9e9,_0x39a243);}_0x41517f((_0x695753=_0x695753['apply'](_0x39032d,_0x5fd644||[]))[a6_0x32ce('0x42')]());});};Object['defineProperty'](exports,'__esModule',{'value':!![]});exports[a6_0x32ce('0x25')]=void 0x0;const fs_1=require('fs');const stripJsonComments=require(a6_0x32ce('0x37'));const yargsParser=require(a6_0x32ce('0x47'));const environment_1=require('../../../utilities/environment');const metric_logger_1=require('../../../utilities/metric-logger');const print_cacheable_targets_error_1=require(a6_0x32ce('0x21'));const print_invalid_runner_error_1=require(a6_0x32ce('0x3f'));const print_run_group_error_1=require('../../error/print-run-group-error');const distributed_agent_api_1=require('./distributed-agent.api');const execute_tasks_1=require(a6_0x32ce('0x30'));const dte_artifact_storage_1=require(a6_0x32ce('0x36'));const file_storage_1=require(a6_0x32ce('0x3c'));const e2e_encryption_1=require(a6_0x32ce('0xa'));const error_reporter_api_1=require(a6_0x32ce('0x32'));const invoke_tasks_using_run_many_1=require('./invoke-tasks-using-run-many');const invoke_tasks_using_nx_imperative_api_1=require(a6_0x32ce('0x28'));const is_workspace_enabled_1=require(a6_0x32ce('0x1d'));const {output,workspaceRoot}=require(a6_0x32ce('0x2'));const {initTasksRunner,cacheDirectory}=require('../../../utilities/nx-imports');const args=yargsParser(process[a6_0x32ce('0x56')],{'array':[a6_0x32ce('0x3e')],'default':{}});if(args[a6_0x32ce('0x3e')]&&args[a6_0x32ce('0x3e')][a6_0x32ce('0x13')]===0x1){args[a6_0x32ce('0x3e')]=args[a6_0x32ce('0x3e')][0x0]['split'](',')[a6_0x32ce('0x34')](_0x5b2f5c=>_0x5b2f5c[a6_0x32ce('0x17')]());}function startAgent(){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x512d86=(0x0,environment_1[a6_0x32ce('0x1a')])();const _0x80656e=(0x0,environment_1['getRunGroup'])();const _0x5de240=(0x0,environment_1[a6_0x32ce('0x19')])();const _0x2edb98=(0x0,environment_1[a6_0x32ce('0x3b')])();if(!(0x0,print_run_group_error_1[a6_0x32ce('0x44')])(_0x80656e,_0x5de240)){(0x0,print_run_group_error_1[a6_0x32ce('0x6')])();process[a6_0x32ce('0x26')](0x1);}if(args[a6_0x32ce('0x3e')]&&args['targets']['length']){output[a6_0x32ce('0x4')]({'title':a6_0x32ce('0x1')+args[a6_0x32ce('0x3e')][a6_0x32ce('0x18')](',\x20')+']'});}else{output[a6_0x32ce('0x4')]({'title':a6_0x32ce('0x4e')});}const _0x414071=JSON[a6_0x32ce('0x12')](stripJsonComments((0x0,fs_1[a6_0x32ce('0x4a')])(workspaceRoot+a6_0x32ce('0x9'))['toString']()))[a6_0x32ce('0x20')]['default'];if(_0x414071[a6_0x32ce('0x2a')]!=='nx-cloud'&&_0x414071[a6_0x32ce('0x2a')]!==a6_0x32ce('0x5')){(0x0,print_invalid_runner_error_1[a6_0x32ce('0x45')])();return process[a6_0x32ce('0x26')](0x1);}const _0x2b2fb2=_0x414071[a6_0x32ce('0xb')];if(args[a6_0x32ce('0x3e')]&&args[a6_0x32ce('0x3e')][a6_0x32ce('0x41')](_0x30a86c=>{var _0x2da015;return!((_0x2da015=_0x2b2fb2[a6_0x32ce('0x16')])===null||_0x2da015===void 0x0?void 0x0:_0x2da015['includes'](_0x30a86c));})){const _0x916f9b=args[a6_0x32ce('0x3e')][a6_0x32ce('0x39')](_0x1eafdb=>{var _0x26e3f5;return!((_0x26e3f5=_0x2b2fb2[a6_0x32ce('0x16')])===null||_0x26e3f5===void 0x0?void 0x0:_0x26e3f5[a6_0x32ce('0x4b')](_0x1eafdb));});(0x0,print_cacheable_targets_error_1['printCacheableTargetsError'])(_0x916f9b);return process[a6_0x32ce('0x26')](0x1);}const _0x3ca8bd=yield(0x0,is_workspace_enabled_1[a6_0x32ce('0x52')])(_0x2b2fb2);if(!_0x3ca8bd){output['error']({'title':a6_0x32ce('0x54'),'bodyLines':[a6_0x32ce('0x49'),'',a6_0x32ce('0x4f')]});process[a6_0x32ce('0x26')](0x1);}const _0xcc15d0=getAgentName();const _0x4a46c8=new distributed_agent_api_1[(a6_0x32ce('0x38'))](_0x2b2fb2,_0x512d86,_0x80656e,_0x5de240,_0x2edb98,_0xcc15d0);createAgentLockfileAndSetUpListeners(_0x4a46c8,_0x2b2fb2,_0xcc15d0);const _0x2a6601=new e2e_encryption_1[(a6_0x32ce('0x40'))](environment_1[a6_0x32ce('0x24')]||_0x2b2fb2[a6_0x32ce('0x48')]);const _0x563a19=new error_reporter_api_1['ErrorReporterApi'](_0x2b2fb2);const _0x3e5457=new dte_artifact_storage_1[(a6_0x32ce('0x2f'))](new file_storage_1[(a6_0x32ce('0x43'))](_0x2a6601,_0x563a19,_0x2b2fb2,a6_0x32ce('0x4c')),cacheDirectory);const _0x38539b=initTasksRunner?yield(0x0,invoke_tasks_using_nx_imperative_api_1[a6_0x32ce('0x10')])(_0x2b2fb2):yield(0x0,invoke_tasks_using_run_many_1[a6_0x32ce('0x2e')])();return(0x0,execute_tasks_1[a6_0x32ce('0x3a')])(_0xcc15d0,_0x4a46c8,_0x3e5457,_0x38539b,args[a6_0x32ce('0x3e')])[a6_0x32ce('0x15')](_0x321db7=>__awaiter(this,void 0x0,void 0x0,function*(){yield(0x0,metric_logger_1[a6_0x32ce('0x31')])(_0x2b2fb2);return _0x321db7;}))[a6_0x32ce('0x2d')](_0x5b1b1b=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x4a46c8['completeRunGroupWithError'](a6_0x32ce('0x27')+_0x5b1b1b[a6_0x32ce('0x4d')]+'\x22');throw _0x5b1b1b;}));});}exports[a6_0x32ce('0x25')]=startAgent;function getAgentName(){if(process[a6_0x32ce('0x35')]['NX_AGENT_NAME']!==undefined){return process[a6_0x32ce('0x35')][a6_0x32ce('0x29')];}else if(process[a6_0x32ce('0x35')][a6_0x32ce('0x55')]!==undefined&&process[a6_0x32ce('0x35')][a6_0x32ce('0x0')]){return process[a6_0x32ce('0x35')][a6_0x32ce('0x0')];}else if(process[a6_0x32ce('0x35')][a6_0x32ce('0x55')]!==undefined&&process[a6_0x32ce('0x35')][a6_0x32ce('0x2c')]){return process[a6_0x32ce('0x35')][a6_0x32ce('0x2c')];}else{return'Agent\x20'+Math[a6_0x32ce('0x3d')](Math['random']()*0x186a0);}}function createAgentLockfileAndSetUpListeners(_0x15ba17,_0x4e9e42,_0x5831db){const _0x211d4a=cacheDirectory+a6_0x32ce('0x53');const _0x5a0e6c=_0x211d4a+'/'+_0x5831db+a6_0x32ce('0x7');if(!(0x0,fs_1[a6_0x32ce('0x51')])(_0x211d4a)){(0x0,fs_1[a6_0x32ce('0x33')])(_0x211d4a,{'recursive':!![]});}const _0x5928b7=(0x0,fs_1[a6_0x32ce('0xe')])(_0x211d4a);if(_0x5928b7[a6_0x32ce('0x13')]){if(_0x5928b7[a6_0x32ce('0x4b')](_0x5831db+a6_0x32ce('0x7'))){output['error']({'title':a6_0x32ce('0x50'),'bodyLines':[a6_0x32ce('0x14'),'',a6_0x32ce('0x23')]});process[a6_0x32ce('0x26')](0x1);}output[a6_0x32ce('0x1f')]({'title':a6_0x32ce('0x2b'),'bodyLines':[a6_0x32ce('0x1e'),'','This\x20can\x20also\x20be\x20a\x20false\x20positive\x20caused\x20by\x20agents\x20that\x20did\x20not\x20shut\x20down\x20correctly.',a6_0x32ce('0x8')]});}(0x0,fs_1[a6_0x32ce('0x1b')])(_0x5a0e6c,'');process['on']('exit',_0x2569aa=>{cleanupAgentLockfile(_0x5a0e6c,_0x2569aa);});process['on'](a6_0x32ce('0xf'),()=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x15ba17[a6_0x32ce('0x22')](a6_0x32ce('0xd'));cleanupAgentLockfile(_0x5a0e6c,0x1);}));process['on'](a6_0x32ce('0x46'),()=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x15ba17['completeRunGroupWithError'](a6_0x32ce('0x1c'));cleanupAgentLockfile(_0x5a0e6c,0x1);}));}function cleanupAgentLockfile(_0x281511,_0x55f92a){if((0x0,fs_1[a6_0x32ce('0x51')])(_0x281511)){(0x0,fs_1[a6_0x32ce('0x3')])(_0x281511);process[a6_0x32ce('0x26')](_0x55f92a);}}