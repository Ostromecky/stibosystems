"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const validate_options_1 = require("./lib/validate-options");
const devkit_1 = require("@nx/devkit");
const buildable_libs_1 = require("./lib/buildable-libs");
const ngcli_adapter_1 = require("nx/src/adapter/ngcli-adapter");
function esbuildExecutor(options, context) {
    var _a;
    return tslib_1.__asyncGenerator(this, arguments, function* esbuildExecutor_1() {
        (0, validate_options_1.validateOptions)(options);
        (_a = options.buildLibsFromSource) !== null && _a !== void 0 ? _a : (options.buildLibsFromSource = true);
        const { buildLibsFromSource } = options, delegateExecutorOptions = tslib_1.__rest(options, ["buildLibsFromSource"]);
        let dependencies;
        let projectGraph = context.projectGraph;
        if (!buildLibsFromSource) {
            projectGraph = projectGraph !== null && projectGraph !== void 0 ? projectGraph : (0, devkit_1.readCachedProjectGraph)();
            const { tsConfigPath, dependencies: foundDependencies } = (0, buildable_libs_1.createTmpTsConfigForBuildableLibs)(delegateExecutorOptions.tsConfig, context, { projectGraph });
            dependencies = foundDependencies;
            delegateExecutorOptions.tsConfig = tsConfigPath;
        }
        const { buildEsbuildBrowser } = yield tslib_1.__await(Promise.resolve().then(() => require('@angular-devkit/build-angular/src/builders/browser-esbuild/index')));
        const builderContext = yield tslib_1.__await((0, ngcli_adapter_1.createBuilderContext)({
            builderName: 'browser-esbuild',
            description: 'Build a browser application',
            optionSchema: yield tslib_1.__await(Promise.resolve().then(() => require('@angular-devkit/build-angular/src/builders/browser-esbuild/schema.json'))),
        }, context));
        return yield tslib_1.__await(yield tslib_1.__await(yield* tslib_1.__asyncDelegator(tslib_1.__asyncValues(buildEsbuildBrowser(delegateExecutorOptions, builderContext)))));
    });
}
exports.default = esbuildExecutor;
